{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.3.539.46024",
      "templateHash": "15811394329660058593"
    }
  },
  "parameters": {
    "sigrg": {
      "type": "string",
      "defaultValue": "Bicep-SIG-Collaboration"
    },
    "uamiName": {
      "type": "string",
      "defaultValue": "[format('{0}{1}', 'AIBUser', utcNow())]"
    }
  },
  "functions": [],
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2020-06-01",
      "name": "[parameters('sigrg')]",
      "location": "northeurope"
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "wvdsig",
      "resourceGroup": "[parameters('sigrg')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "uamiName": {
            "value": "[parameters('uamiName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.3.539.46024",
              "templateHash": "5562634446158201994"
            }
          },
          "parameters": {
            "subid": {
              "type": "string",
              "defaultValue": "[subscription().id]"
            },
            "rgid": {
              "type": "string",
              "defaultValue": "[resourceGroup().id]"
            },
            "imagePublisher": {
              "type": "string",
              "defaultValue": "MicrosoftWindowsDesktop"
            },
            "imageDefinitionName": {
              "type": "string",
              "defaultValue": "BicepAIBWVDImage"
            },
            "imageOffer": {
              "type": "string",
              "defaultValue": "windows-10"
            },
            "imageSKU": {
              "type": "string",
              "defaultValue": "20h2-ent"
            },
            "imageLocation": {
              "type": "string",
              "defaultValue": "northeurope"
            },
            "roleNameGalleryImage": {
              "type": "string",
              "defaultValue": "[format('{0}{1}', 'BicepAIB', utcNow())]"
            },
            "imageTemplateName": {
              "type": "string",
              "defaultValue": "[format('{0}{1}', 'WVDBicep', utcNow())]"
            },
            "svclocation": {
              "type": "string",
              "defaultValue": "northeurope"
            },
            "uamiName": {
              "type": "string",
              "defaultValue": "[format('{0}{1}', 'AIBUser', utcNow())]"
            },
            "uamiId": {
              "type": "string",
              "defaultValue": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uamiName'))]"
            },
            "outputname": {
              "type": "string",
              "defaultValue": "[uniqueString(resourceGroup().name)]"
            },
            "roleName": {
              "type": "string",
              "defaultValue": "[format('{0}{1}', 'AIBRoleForSIG', utcNow())]"
            },
            "sigName": {
              "type": "string",
              "defaultValue": "wvdbicepsig"
            },
            "sigLocation": {
              "type": "string",
              "defaultValue": "northeurope"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Compute/galleries",
              "apiVersion": "2020-09-30",
              "name": "[parameters('sigName')]",
              "location": "[parameters('sigLocation')]"
            },
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2018-11-30",
              "name": "[parameters('uamiName')]",
              "location": "[resourceGroup().location]"
            },
            {
              "type": "Microsoft.Authorization/roleDefinitions",
              "apiVersion": "2018-01-01-preview",
              "name": "[guid(parameters('roleNameGalleryImage'))]",
              "properties": {
                "roleName": "[format('{0}{1}', parameters('roleName'), parameters('sigName'))]",
                "description": "Custom role for network read",
                "permissions": [
                  {
                    "actions": [
                      "Microsoft.Compute/galleries/read",
                      "Microsoft.Compute/galleries/images/read",
                      "Microsoft.Compute/galleries/images/versions/read",
                      "Microsoft.Compute/galleries/images/versions/write",
                      "Microsoft.Compute/images/write",
                      "Microsoft.Compute/images/read",
                      "Microsoft.Compute/images/delete"
                    ]
                  }
                ],
                "assignableScopes": [
                  "[resourceGroup().id]"
                ]
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "name": "[guid(resourceGroup().id, resourceId('Microsoft.Authorization/roleDefinitions', guid(parameters('roleNameGalleryImage'))), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uamiName')))]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', guid(parameters('roleNameGalleryImage')))]",
                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uamiName'))).principalId]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Authorization/roleDefinitions', guid(parameters('roleNameGalleryImage')))]",
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uamiName'))]"
              ]
            },
            {
              "type": "Microsoft.Compute/galleries/images",
              "apiVersion": "2019-07-01",
              "name": "[format('{0}/{1}', parameters('sigName'), parameters('imageDefinitionName'))]",
              "location": "[parameters('sigLocation')]",
              "properties": {
                "osType": "Windows",
                "osState": "Generalized",
                "identifier": {
                  "publisher": "[parameters('imagePublisher')]",
                  "offer": "[parameters('imageOffer')]",
                  "sku": "[parameters('imageSKU')]"
                },
                "recommended": {
                  "vCPUs": {
                    "min": 2,
                    "max": 32
                  },
                  "memory": {
                    "min": 4,
                    "max": 64
                  }
                },
                "hyperVGeneration": "V2"
              },
              "tags": {}
            }
          ],
          "outputs": {
            "siginfo": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Compute/galleries', parameters('sigName')), '2020-09-30', 'full').location]"
            },
            "uamioutput": {
              "type": "string",
              "value": "[parameters('uamiId')]"
            },
            "galleryimageId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Compute/galleries/images', split(format('{0}/{1}', parameters('sigName'), parameters('imageDefinitionName')), '/')[0], split(format('{0}/{1}', parameters('sigName'), parameters('imageDefinitionName')), '/')[1])]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('sigrg'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "[format('wvdimagebuilder{0}', 'wvdsig')]",
      "resourceGroup": "[parameters('sigrg')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "siglocation": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('sigrg')), 'Microsoft.Resources/deployments', 'wvdsig'), '2019-10-01').outputs.siginfo.value]"
          },
          "galleryImageId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('sigrg')), 'Microsoft.Resources/deployments', 'wvdsig'), '2019-10-01').outputs.galleryimageId.value]"
          },
          "userAssignedIdentities": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('sigrg')), 'Microsoft.Resources/deployments', 'wvdsig'), '2019-10-01').outputs.uamioutput.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.3.539.46024",
              "templateHash": "1304598456876403220"
            }
          },
          "parameters": {
            "siglocation": {
              "type": "string"
            },
            "imageTemplateName": {
              "type": "string",
              "defaultValue": "[format('{0}{1}', 'WVDBicep', utcNow())]"
            },
            "galleryImageId": {
              "type": "string"
            },
            "outputname": {
              "type": "string",
              "defaultValue": "[uniqueString(resourceGroup().name)]"
            },
            "userAssignedIdentities": {
              "type": "string"
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.VirtualMachineImages/imageTemplates",
              "apiVersion": "2020-02-14",
              "name": "[parameters('imageTemplateName')]",
              "location": "[parameters('siglocation')]",
              "tags": {
                "imagebuilderTemplate": "AzureImageBuilderSIG",
                "userIdentity": "enabled"
              },
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "userAssignedIdentities": {}
                }
              },
              "properties": {
                "buildTimeoutInMinutes": 120,
                "vmProfile": {
                  "vmSize": "Standard_D2_v2",
                  "osDiskSizeGB": 127
                },
                "source": {
                  "type": "PlatformImage",
                  "publisher": "MicrosoftWindowsDesktop",
                  "offer": "windows-10",
                  "sku": "20h2-ent",
                  "version": "latest"
                },
                "customize": [
                  {
                    "type": "PowerShell",
                    "name": "OptimizeOS",
                    "runElevated": true,
                    "runAsSystem": true,
                    "scriptUri": "https://raw.githubusercontent.com/danielsollondon/azvmimagebuilder/master/solutions/14_Building_Images_WVD/1_Optimize_OS_for_WVD.ps1"
                  },
                  {
                    "type": "WindowsRestart",
                    "restartCheckCommand": "write-host 'restarting post Optimizations'",
                    "restartTimeout": "5m"
                  },
                  {
                    "type": "PowerShell",
                    "name": "Install Teams",
                    "runElevated": true,
                    "runAsSystem": true,
                    "scriptUri": "https://raw.githubusercontent.com/danielsollondon/azvmimagebuilder/master/solutions/14_Building_Images_WVD/2_installTeams.ps1"
                  },
                  {
                    "type": "WindowsRestart",
                    "restartCheckCommand": "write-host 'restarting post Teams Install'",
                    "restartTimeout": "5m"
                  },
                  {
                    "type": "WindowsUpdate",
                    "searchCriteria": "IsInstalled=0",
                    "filters": [
                      "exclude:$_.Title -like '*Preview*'",
                      "include:$true"
                    ],
                    "updateLimit": 40
                  }
                ],
                "distribute": [
                  {
                    "type": "SharedImage",
                    "galleryImageId": "[parameters('galleryImageId')]",
                    "runOutputName": "[parameters('outputname')]",
                    "artifactTags": {
                      "source": "wvd10",
                      "baseosimg": "windows10"
                    },
                    "replicationRegions": [
                      "northeurope"
                    ]
                  }
                ]
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('sigrg')), 'Microsoft.Resources/deployments', 'wvdsig')]"
      ]
    }
  ]
}